# Dataset Sync & Manifest Tools

This repository provides two Python scripts to help manage multimodal datasets
(e.g. LiDAR + multiple cameras + depth) for training, validation, and testing.

---

## Expected Dataset Structure

Each session lives in a `<scenario>_label/` folder.

```
dataset_root/
├─ footpath1_1walk_1stand_st_11_12_2024_1_label/
│  ├─ sensor_data/
│  │  ├─ lidar/                # *.pcd files
│  │  ├─ cam_fish_left/        # *.png
│  │  ├─ cam_fish_front/       # *.png
│  │  ├─ cam_fish_right/       # *.png
│  │  ├─ cam_zed_rgb/          # *.png
│  │  └─ cam_zed_depth/        # *.npy
│  │
│  ├─ annotations/
│  │  ├─ lidar_ann.json
│  │  ├─ cam_fish_left_ann.json
│  │  ├─ cam_fish_front_ann.json
│  │  ├─ cam_fish_right_ann.json
│  │  ├─ cam_zed_rgb_ann.json
│  │  └─ cam_zed_depth_ann.json   # optional
│  │
│  ├─ metadata/
│  │  └─ meta.json
│  │
│  ├─ calibration/
│  │  ├─ intrinsics.json
│  │  └─ extrinsics.json
│  │
│  └─ sync.json    # generated by sync_and_match.py
│
├─ out_straw_1look_robot_st_11_07_2024_2_label/
│  └─ ...
│
└─ info_file.csv   # optional legacy metadata
```

Legacy folder names (e.g. `fisheye_images_12/13/14`, `output_images`, `lidar_points`) are
normalized into the above canonical `sensor_data/` subfolder names.

---

## Scripts Overview

### 1. `sync_and_match.py`
- Anchors all frames to a chosen **modality** (e.g. `cam_zed_rgb` or `lidar`).
- Synchronizes sensor streams by timestamp within a configurable threshold.
- Produces `sync.json` inside each session folder with:
  - Chosen threshold
  - Clock offsets
  - Per-sample matched files
- Supports both JSON and YAML config files.

### 2. `build_manifest_and_splits.py`
- Consumes per-session `sync.json` outputs.
- Builds two manifest files:
  - `manifest_samples.tsv` — one row per anchor frame, with paths to other modalities or `"null"` if not synced.
  - `sessions.tsv` — one row per session with metadata summary.
- Optionally splits data into train/val/test text files.
- Supports JSON and YAML config files.

---

## Configuration

Both scripts accept a `--config` argument pointing to either JSON or YAML.

### Example YAML config

```yaml
anchor: cam_zed_rgb
session_glob: "*_label"

include_modalities:
  - lidar
  - cam_fish_left
  - cam_fish_front
  - cam_fish_right
  - cam_zed_depth

# Booleans equivalent to CLI flags
include_orphans: true   # same as --include_orphans
do_splits: false        # same as --no_splits

seed: 42
thresholds: [0.10, 0.12, 0.13, 0.15, 0.20]
p95_limit_s: 0.05
plateau_eps: 0.2

# Attach JSONL streams (e.g., `gps_fix`, `gps_odom`, `yaw`, `tf`) to each manifest row via config:
metadata_sync:
  - name: gps_fix
    rel_path: metadata/gps_fix.jsonl
    ts_key: t
    max_dt_ms: 200
    mode: nearest
    store_fields: [latitude, longitude, altitude]
    output_prefix: gps
    also_store_pointer: true
  - name: tf_odom_to_base
    rel_path: metadata/tf/odom__to__base_link.jsonl
    ts_key: t
    max_dt_ms: 100
    mode: nearest
    store_fields: []
    output_prefix: tf_o2b
    also_store_pointer: true
```

### Example JSON config

```json
{
  "anchor": "cam_zed_rgb",
  "include_modalities": ["lidar", "cam_fish_left", "cam_fish_front"],
  "include_orphans": true,
  "do_splits": false,
  "seed": 42,
  "thresholds": [0.10, 0.15, 0.20],
  "p95_limit_s": 0.05,
  "plateau_eps": 0.2
}
```

---

## Usage

### 1. Synchronize and match frames

```bash
# Process all *_label under root
python sync_and_match.py /abs/path/to/data/ --config config.yaml

# Or limit to a list and auto-append suffix where needed
python sync_and_match.py /data/ds --config cfg.yaml --scenarios_file /lists/keep.txt --list_suffix "_label"
```
This will create `sync.json` in each `<scenario>_label` folder.
Outputs:
- `manifest_samples.tsv`
- `sessions.tsv`
- (optional) `train.txt`, `val.txt`, `test.txt`

### 2. Build manifest and splits

```bash
# Build manifest only (no splits), after running sync
python build_manifest_and_splits.py --root /abs/path/to/data/ --config cfg.yaml --no_splits

# In one step: run sync first, then manifest
python build_manifest_and_splits.py --root /abs/path/to/data/ --config cfg.yaml --run_sync --no_splits

# Limit to a list
python build_manifest_and_splits.py --root /abs/path/to/data/ --config cfg.yaml   --scenarios_file /lists/keep.csv --list_suffix "_label" --no_splits
```

- Reads `sync.json` from each session.
- Outputs:
  - `manifest_samples.tsv` — one row per anchor frame, with per-modality paths or `null`.
  - `sessions.tsv` — one row per session.
  - Optional `splits/default/{train,val,test}.txt` (session-grouped).

_**Note:**_
1) If you pass **`--scenarios_file PATH`**, the file is **authoritative**.
   - The file can live **anywhere** on disk (absolute or relative path).
   - Formats: `.txt/.lst` (one folder name per line), `.csv/.tsv` (column
     `session_id` or `folder`), `.json` (array), `.yml/.yaml` (list).
   - Names may be either **exact folder names** (e.g., `foo_..._label`) or
     **base names** (e.g., `foo_...`) — the scripts will try to append
     the suffix from `--list_suffix` (default: `_label`) when needed.
   - The scripts print a **Missing from list** report for names that could
     not be resolved to existing folders under `--root`.
2) If **no** `--scenarios_file` is given, the scripts process **all folders
   under `--root` that end with `_label`**.

---

## CLI Flags vs Config

- `--include_orphans` = overrides config and forces `include_orphans=True`.
- `--no_splits` = overrides config and forces `do_splits=False`.
- `--seed N` = overrides config `"seed"`.

If neither CLI flag nor config is given:
- `include_orphans` defaults to `False`.
- `do_splits` defaults to `True`.
- `seed` defaults to `42`.

---

## Dependencies

- Python 3.9+
- numpy
- (optional) PyYAML for YAML configs

Install with:

```bash
pip install numpy pyyaml
```

---

## Notes

- Anchor can be any modality defined in config (commonly `lidar` or `cam_zed_rgb`).
- If a modality is missing for a frame, the manifest will record `"null"` in that field.
- Calibration is assumed fixed per scenario; not duplicated per sample.
- Config + CLI merge: **config is base, CLI overrides when provided**.
